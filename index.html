<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Cplus3 by wangfakang</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Cplus3</h1>
        <p class="header">cplus analysis about virtual function.</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/cplus3/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/cplus3/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/wangfakang/cplus3">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/wangfakang">wangfakang</a></p>


      </header>
      <section>
        <p><code>关于c++虚函数的解析:</code></p>

<p>虚函数给予了c++很强大的特性[多态],那么虚函数在对象中的内存分布又是如何的恩?是如何做多动态的多态的恩?
下面会一一解答这些问题[个人所见,如有错误,欢迎拍砖].</p>

<p>看看如下代码:</p>

<div class="highlight highlight-source-c"><pre>using namespace std;
#<span class="pl-k">include</span><span class="pl-s"><span class="pl-pds">&lt;</span>iostream<span class="pl-pds">&gt;</span></span>


class A {
public:
   virtual <span class="pl-k">void</span> <span class="pl-smi">print</span>() {
        cout&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>A<span class="pl-pds">"</span></span>&lt;&lt;endl;
   }
private:
   <span class="pl-c">//int a;</span>
};


<span class="pl-c">//class B : public virtual A {</span>
class B : public  A {
public:
   virtual <span class="pl-k">void</span> <span class="pl-smi">print</span>() {
        cout&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>B<span class="pl-pds">"</span></span>&lt;&lt;endl;
   }
   virtual <span class="pl-k">void</span> <span class="pl-c1">printf</span>() {
        cout&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>Bf<span class="pl-pds">"</span></span>&lt;&lt;endl;
   }
private:

};


<span class="pl-k">typedef</span> <span class="pl-en">void</span> (*Pfun)();

<span class="pl-k">int</span> <span class="pl-en">main</span>()
{
    A a;
    B b;
    Pfun fun;
    <span class="pl-k">int</span> i = <span class="pl-c1">0</span>;

    <span class="pl-k">for</span>(; i &lt; <span class="pl-c1">2</span>; i++)
    {
         fun = (Pfun) *((<span class="pl-k">int</span>*)*(<span class="pl-k">int</span>*)(&amp;b)+i);
         <span class="pl-c1">fun</span>();

    }
    <span class="pl-k">return</span> <span class="pl-c1">0</span>;

}</pre></div>

<p>输出结果:      </p>

<pre><code>B
Bf
</code></pre>

<h1>
<a id="问题一之虚表指针存放与何处" class="anchor" href="#%E9%97%AE%E9%A2%98%E4%B8%80%E4%B9%8B%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E5%AD%98%E6%94%BE%E4%B8%8E%E4%BD%95%E5%A4%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题一之虚表指针存放与何处:</h1>

<p>gdb调试看到如下:</p>

<pre><code>(gdb) p a
$1 = {_vptr.A = 0x400c70 &lt;vtable for A+16&gt;}
(gdb) p b
$2 = warning: can't find linker symbol for virtual table for `B' value
warning:   found `B::B()' instead
{&lt;A&gt; = {_vptr.A = 0x400ba0 &lt;__libc_csu_init&gt;}, &lt;No data fields&gt;}
</code></pre>

<p>每个对象都有一个vptr指针---虚表指针(用来存放虚函数的地址).<br>
注意:虚表指针位于一个对象的首的前四字节[32位系统].为啥要在放在对象首部恩? 原因很简单,便于后续的查询速度呗.      </p>

<h1>
<a id="问题二之输出结果为啥是这样" class="anchor" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%E4%B9%8B%E8%BE%93%E5%87%BA%E7%BB%93%E6%9E%9C%E4%B8%BA%E5%95%A5%E6%98%AF%E8%BF%99%E6%A0%B7" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题二之输出结果为啥是这样:</h1>

<ul>
<li>1.&amp;b 是对象b的地址<br>
</li>
<li>2.(int<em>)(&amp;b) 把b的地址强转为int</em>,这样便于后面往出取值的时候按照int的方式取.<br>
</li>
<li>3.<em>(int</em>)(&amp;b) 按照int的解析方式,取出对象b地址中的前4字节---虚表指针首地址.<br>
</li>
<li>4.(int<em>)</em>(int*)(&amp;b)+i 表示指向虚表指针的偏移量为i的位置.[此处可以把虚表指针理解为一个指针数组,其中数组中
存放的是虚函数的地址].<br>
</li>
<li>5.(Pfun<em>)((int</em>)(<em>(int</em>)(&amp;b)+i) 把这个int型指针强转为Pfun类型的函数指针.<br>
</li>
<li>6.fun() 调用这个虚函数.<br>
</li>
</ul>

<h1>
<a id="问题三之虚表指针何时共享与否----" class="anchor" href="#%E9%97%AE%E9%A2%98%E4%B8%89%E4%B9%8B%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E4%BD%95%E6%97%B6%E5%85%B1%E4%BA%AB%E4%B8%8E%E5%90%A6----" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题三之虚表指针何时共享与否:    </h1>

<ul>
<li> 1.当非虚拟继承的时候,此时不管子类是否有新的虚函数,此时父子的虚表是共享的.[单继承情况下].<br>
</li>
<li>2.当虚拟继承的时候.如子类出现了新的虚函数,则父与子此时不在共享虚表指针,此时子对象会产生
一个新的虚表指针存放新的虚函数.<br>
</li>
</ul>

<h1>
<a id="问题四之多继承的时候子类的虚表是怎么样的" class="anchor" href="#%E9%97%AE%E9%A2%98%E5%9B%9B%E4%B9%8B%E5%A4%9A%E7%BB%A7%E6%89%BF%E7%9A%84%E6%97%B6%E5%80%99%E5%AD%90%E7%B1%BB%E7%9A%84%E8%99%9A%E8%A1%A8%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E7%9A%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题四之多继承的时候子类的虚表是怎么样的:</h1>

<p>当子类D多继承与类A B C的时候,其中ABC中都有虚函数:     </p>

<ul>
<li>1.当D中发生虚函数覆盖的时候[如D中重写了A中的某一个虚函数],此时A与D是共享虚表的,然后在D中还有另外两个
 虚表存储B和C.<br>
</li>
<li>2.当D中没有发生虚函数覆盖的时候,此时在D中会有4个虚表指针.<br>
</li>
</ul>

<h1>
<a id="communite--" class="anchor" href="#communite--" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Communite  </h1>

<p>在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流</p>

<ul>
<li>邮件(1031379296#qq.com, 把#换成@)</li>
<li>QQ: 1031379296</li>
<li>weibo: <a href="http://weibo.com/fakangwang">@王发康</a>
</li>
</ul>

<h1>
<a id="thx" class="anchor" href="#thx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Thx</h1>

<ul>
<li>chunshengsterATgmail.com</li>
</ul>

<h1>
<a id="author" class="anchor" href="#author" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Author</h1>

<ul>
<li>Linux\nginx\golang\c\c++爱好者</li>
<li>欢迎一起交流  一起学习# </li>
<li>Others say good and Others good</li>
</ul>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("cplus analysis about virtual function.");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
